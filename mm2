-- ========================================
-- AUTO-REJOIN & AUTO-EXECUTE (ULTRA SIMPLE)
-- ========================================

local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")

if not _G.MM2ScriptURL then
    _G.MM2ScriptURL = "https://raw.githubusercontent.com/HellishHumanoid/test/refs/heads/main/mm2"
end

-- ========================================
-- SAVE SYSTEM
-- ========================================

local hasFileSystem = writefile and readfile and isfile and makefolder

if hasFileSystem then
    if not isfolder("MM2Settings") then
        makefolder("MM2Settings")
    end
end

local function saveSettings(espEnabled, autofarmEnabled)
    if not hasFileSystem then return end
    
    local settings = {
        ESPEnabled = espEnabled,
        AutofarmEnabled = autofarmEnabled
    }
    
    pcall(function()
        writefile("MM2Settings/config.json", HttpService:JSONEncode(settings))
        print("üíæ Settings saved")
    end)
end

local function loadSettings()
    if not hasFileSystem then return nil end
    
    if isfile("MM2Settings/config.json") then
        local success, result = pcall(function()
            local data = readfile("MM2Settings/config.json")
            return HttpService:JSONDecode(data)
        end)
        
        if success and result then
            print("üìÇ Settings loaded from previous session")
            return result
        end
    end
    
    return nil
end

local savedSettings = loadSettings()

-- Function to rejoin
local function rejoinGame()
    print("Rejoining...")
    wait(1)
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end

-- CRITICAL: Queue on EVERY teleport attempt
if queueonteleport then
    queueonteleport([[
        repeat wait() until game:IsLoaded()
        wait(8)
        loadstring(game:HttpGet("https://raw.githubusercontent.com/HellishHumanoid/test/refs/heads/main/mm2"))()
    ]])
    print("‚úì Script queued for next teleport")
end

LocalPlayer.OnTeleport:Connect(function()
    if queueonteleport then
        queueonteleport([[
            repeat wait() until game:IsLoaded()
            wait(8)
            loadstring(game:HttpGet("https://raw.githubusercontent.com/HellishHumanoid/test/refs/heads/main/mm2"))()
        ]])
    end
end)

-- Detect kicks - Method 1
game:GetService("CoreGui").DescendantAdded:Connect(function(descendant)
    if descendant.Name == "ErrorPrompt" or descendant.Name == "RobloxPromptGui" then
        wait(0.5)
        for _, child in pairs(descendant:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") then
                local text = string.lower(child.Text)
                if string.find(text, "kick") or string.find(text, "disconnect") or string.find(text, "banned") then
                    rejoinGame()
                    break
                end
            end
        end
    end
end)

-- Detect kicks - Method 2
local lastError = ""
game:GetService("GuiService").ErrorMessageChanged:Connect(function()
    local currentError = game:GetService("GuiService"):GetErrorMessage()
    if currentError ~= lastError and currentError ~= "" then
        lastError = currentError
        wait(0.5)
        rejoinGame()
    end
end)

print("===============================================")
print("Auto-Rejoin & Auto-Execute Loaded")
print("===============================================")

-- ========================================
-- NUCLEAR CLEANUP SYSTEM
-- ========================================

local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

if _G.MurderMysteryESP and _G.MurderMysteryESP.Connections then
    for _, connection in pairs(_G.MurderMysteryESP.Connections) do
        pcall(function()
            connection:Disconnect()
        end)
    end
end

if _G.MurderMysteryESP and _G.MurderMysteryESP.ActiveTweens then
    for _, tween in pairs(_G.MurderMysteryESP.ActiveTweens) do
        pcall(function()
            tween:Cancel()
        end)
    end
end

_G.MurderMysteryESP = nil
_G.MurderMysteryESP_Highlights = nil

task.wait(0.1)

for _, gui in pairs(CoreGui:GetChildren()) do
    if string.find(gui.Name:lower(), "luminosity") or gui.Name == "Hellish" or gui.Name == "LuminosityUI" then
        gui:Destroy()
    end
end

if LocalPlayer:FindFirstChild("PlayerGui") then
    for _, gui in pairs(LocalPlayer.PlayerGui:GetChildren()) do
        if string.find(gui.Name:lower(), "luminosity") or gui.Name == "Hellish" or gui.Name == "LuminosityUI" then
            gui:Destroy()
        end
    end
end

for _, gui in pairs(CoreGui:GetChildren()) do
    if gui:IsA("ScreenGui") then
        for _, child in pairs(gui:GetDescendants()) do
            if child.Name and (string.find(child.Name:lower(), "murder") or string.find(child.Name:lower(), "esp")) then
                gui:Destroy()
                break
            end
        end
    end
end

task.wait(0.1)

local highlightsDestroyed = 0
for _, obj in pairs(workspace:GetDescendants()) do
    if obj:IsA("Highlight") then
        obj:Destroy()
        highlightsDestroyed = highlightsDestroyed + 1
    end
end

for _, player in pairs(Players:GetPlayers()) do
    if player.Character then
        for _, obj in pairs(player.Character:GetDescendants()) do
            if obj:IsA("Highlight") then
                obj:Destroy()
            end
        end
    end
    
    local workspaceChar = workspace:FindFirstChild(player.Name)
    if workspaceChar then
        for _, obj in pairs(workspaceChar:GetDescendants()) do
            if obj:IsA("Highlight") then
                obj:Destroy()
            end
        end
    end
end

print("Cleanup complete: Destroyed " .. highlightsDestroyed .. " highlights")
task.wait(0.5)

-- ========================================
-- SCRIPT INITIALIZATION
-- ========================================

local LuminosityUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Jshawk/luminosity-lite/refs/heads/main/Luminosity%20Lite%20UI.lua"))()

if not LuminosityUI then
    error("Failed to load Luminosity UI - Library returned nil")
end

if not _G.MurderMysteryESP then
    _G.MurderMysteryESP = {}
end

_G.MurderMysteryESP = {
    Connections = {},
    ActiveTweens = {},
    Highlights = {},
    Enabled = false,
    ESPEnabled = false,
    Window = nil
}

local function TrackConnection(connection)
    table.insert(_G.MurderMysteryESP.Connections, connection)
    return connection
end

local function TrackTween(tween)
    table.insert(_G.MurderMysteryESP.ActiveTweens, tween)
    return tween
end

-- ========================================
-- CONFIGURATION
-- ========================================

local ESPConfig = {
    Enabled = false,
    SheriffColor = Color3.fromRGB(0, 100, 255),
    MurdererColor = Color3.fromRGB(255, 0, 0),
    CivilianColor = Color3.fromRGB(0, 255, 0),
    HighlightTransparency = 0.5,
    OutlineTransparency = 0
}

local AutofarmEnabled = false
local noclipConnection = nil

local function setNoclip(enabled)
    if enabled then
        if noclipConnection then
            noclipConnection:Disconnect()
        end
        
        noclipConnection = TrackConnection(RunService.Stepped:Connect(function()
            pcall(function()
                local character = LocalPlayer.Character
                if character then
                    for _, part in pairs(character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
        end))
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        
        pcall(function()
            local character = LocalPlayer.Character
            if character then
                for _, part in pairs(character:GetDescendants()) do
                    if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
                        part.CanCollide = true
                    end
                end
            end
        end)
    end
end

local PlayerRoles = {}
local Highlights = {}

-- ========================================
-- CREATE UI WINDOW
-- ========================================

local window = LuminosityUI:CreateWindow("MM2")
_G.MurderMysteryESP.Window = window

local screenGui = nil
task.spawn(function()
    task.wait(0.5)
    for _, gui in pairs(CoreGui:GetChildren()) do
        if gui:IsA("ScreenGui") and (string.find(gui.Name:lower(), "luminosity") or gui:FindFirstChild("Main")) then
            screenGui = gui
            break
        end
    end
    
    if not screenGui and LocalPlayer:FindFirstChild("PlayerGui") then
        for _, gui in pairs(LocalPlayer.PlayerGui:GetChildren()) do
            if gui:IsA("ScreenGui") and (string.find(gui.Name:lower(), "luminosity") or gui:FindFirstChild("Main")) then
                screenGui = gui
                break
            end
        end
    end
end)

local mainTab = window:AddTab("Main")
mainTab:AddSection("ESP Features")

-- ESP Toggle with save system
local savedESP = (savedSettings and savedSettings.ESPEnabled) or false

mainTab:AddToggle("Enable ESP", savedESP, function(Value)
    ESPConfig.Enabled = Value
    _G.MurderMysteryESP.ESPEnabled = Value
    
    -- Save setting
    saveSettings(Value, AutofarmEnabled)
    
    for player, highlight in pairs(Highlights) do
        if highlight and highlight.Parent then
            highlight:Destroy()
        end
    end
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Highlight") then
            obj:Destroy()
        end
    end
    
    Highlights = {}
    PlayerRoles = {}
    _G.MurderMysteryESP.Highlights = {}
    
    if Value then
        task.wait(0.1)
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                updatePlayerESP(player)
            end
        end
    end
end)

-- Apply saved ESP setting
if savedESP then
    ESPConfig.Enabled = true
    _G.MurderMysteryESP.ESPEnabled = true
    print("‚úì ESP restored from saved settings")
end

mainTab:AddSeparator()
mainTab:AddSection("Autofarm Features")

-- Autofarm Toggle with save system
local savedAutofarm = (savedSettings and savedSettings.AutofarmEnabled) or false

mainTab:AddToggle("Coin Autofarm", savedAutofarm, function(Value)
    AutofarmEnabled = Value
    
    -- Save setting
    saveSettings(ESPConfig.Enabled, Value)
    
    if not Value then
        setNoclip(false)
        
        pcall(function()
            local character = LocalPlayer.Character
            if character then
                local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                if humanoidRootPart then
                    local bodyVelocity = humanoidRootPart:FindFirstChild("AntiGravity")
                    if bodyVelocity then
                        bodyVelocity:Destroy()
                    end
                end
            end
        end)
        
        pcall(function()
            for _, obj in pairs(workspace:GetChildren()) do
                if obj.Name == "AutofarmPlatform" then
                    obj:Destroy()
                end
            end
        end)
    else
        setNoclip(true)
    end
end)

-- Apply saved autofarm setting
if savedAutofarm then
    AutofarmEnabled = true
    setNoclip(true)
    print("‚úì Autofarm restored from saved settings")
end

local settingsTab = window:AddTab("Settings")
settingsTab:AddSection("Controls")
settingsTab:AddLabel("Press 'K' to toggle UI visibility", 14, "center")
settingsTab:AddSeparator()
settingsTab:AddSection("Auto-Rejoin Status")
settingsTab:AddLabel("‚úì Auto-Rejoin: ENABLED", 14, "center")
settingsTab:AddLabel("‚úì Auto-Execute: ENABLED", 14, "center")
settingsTab:AddSeparator()
settingsTab:AddSection("Save System")
if hasFileSystem then
    settingsTab:AddLabel("‚úì Settings Save: ENABLED", 14, "center")
else
    settingsTab:AddLabel("‚úó Settings Save: DISABLED", 14, "center")
end

local UserInputService = game:GetService("UserInputService")
TrackConnection(UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.K then
        if screenGui then
            screenGui.Enabled = not screenGui.Enabled
        else
            for _, gui in pairs(CoreGui:GetChildren()) do
                if gui:IsA("ScreenGui") and (string.find(gui.Name:lower(), "luminosity") or gui:FindFirstChild("Main")) then
                    screenGui = gui
                    screenGui.Enabled = not screenGui.Enabled
                    break
                end
            end
        end
    end
end))

local function checkPlayerForItem(player, itemName)
    if not player then return false end
    
    local character = player.Character
    if character then
        local item = character:FindFirstChild(itemName)
        if item then
            return true
        end
    end
    
    local workspaceCharacter = workspace:FindFirstChild(player.Name)
    if workspaceCharacter then
        local item = workspaceCharacter:FindFirstChild(itemName)
        if item then
            return true
        end
    end
    
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        local item = backpack:FindFirstChild(itemName)
        if item then
            return true
        end
    end
    
    return false
end

local function determinePlayerRole(player)
    if player == LocalPlayer then
        return nil
    end
    
    if checkPlayerForItem(player, "Gun") then
        return "Sheriff"
    end
    
    if checkPlayerForItem(player, "Knife") then
        return "Murderer"
    end
    
    return "Civilian"
end

local function createHighlight(player, role)
    if not ESPConfig.Enabled then return end
    if not player then return end
    if player == LocalPlayer then return end
    
    local character = player.Character or workspace:FindFirstChild(player.Name)
    if not character then return end
    
    for _, obj in pairs(character:GetDescendants()) do
        if obj:IsA("Highlight") then
            obj:Destroy()
        end
    end
    
    if Highlights[player] and Highlights[player].Parent then
        Highlights[player]:Destroy()
    end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    highlight.Adornee = character
    highlight.FillTransparency = ESPConfig.HighlightTransparency
    highlight.OutlineTransparency = ESPConfig.OutlineTransparency
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    
    if role == "Sheriff" then
        highlight.FillColor = ESPConfig.SheriffColor
        highlight.OutlineColor = ESPConfig.SheriffColor
    elseif role == "Murderer" then
        highlight.FillColor = ESPConfig.MurdererColor
        highlight.OutlineColor = ESPConfig.MurdererColor
    elseif role == "Civilian" then
        highlight.FillColor = ESPConfig.CivilianColor
        highlight.OutlineColor = ESPConfig.CivilianColor
    end
    
    highlight.Parent = character
    Highlights[player] = highlight
    
    if _G.MurderMysteryESP then
        _G.MurderMysteryESP.Highlights[player] = highlight
    end
end

function updatePlayerESP(player)
    if not ESPConfig.Enabled then return end
    if player == LocalPlayer then return end
    
    local role = determinePlayerRole(player)
    
    if role then
        PlayerRoles[player] = role
        createHighlight(player, role)
    end
end

local function removePlayerESP(player)
    if Highlights[player] and Highlights[player].Parent then
        Highlights[player]:Destroy()
    end
    Highlights[player] = nil
    PlayerRoles[player] = nil
    
    if _G.MurderMysteryESP and _G.MurderMysteryESP.Highlights then
        _G.MurderMysteryESP.Highlights[player] = nil
    end
end

local function setupPlayerMonitoring(player)
    if player == LocalPlayer then return end
    
    TrackConnection(player.CharacterAdded:Connect(function(character)
        task.wait(0.5)
        updatePlayerESP(player)
        
        TrackConnection(character.ChildAdded:Connect(function(child)
            if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                updatePlayerESP(player)
            end
        end))
        
        TrackConnection(character.ChildRemoved:Connect(function(child)
            if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                task.wait(0.1)
                updatePlayerESP(player)
            end
        end))
    end))
    
    local function monitorWorkspaceCharacter()
        local workspaceChar = workspace:FindFirstChild(player.Name)
        if workspaceChar then
            TrackConnection(workspaceChar.ChildAdded:Connect(function(child)
                if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                    updatePlayerESP(player)
                end
            end))
            
            TrackConnection(workspaceChar.ChildRemoved:Connect(function(child)
                if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                    task.wait(0.1)
                    updatePlayerESP(player)
                end
            end))
        end
    end
    
    monitorWorkspaceCharacter()
    
    TrackConnection(workspace.ChildAdded:Connect(function(child)
        if child.Name == player.Name then
            task.wait(0.5)
            updatePlayerESP(player)
            monitorWorkspaceCharacter()
        end
    end))
    
    local backpack = player:WaitForChild("Backpack", 5)
    if backpack then
        TrackConnection(backpack.ChildAdded:Connect(function(child)
            if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                updatePlayerESP(player)
            end
        end))
        
        TrackConnection(backpack.ChildRemoved:Connect(function(child)
            if child:IsA("Tool") and (child.Name == "Gun" or child.Name == "Knife") then
                task.wait(0.1)
                updatePlayerESP(player)
            end
        end))
    end
    
    if player.Character or workspace:FindFirstChild(player.Name) then
        updatePlayerESP(player)
    end
end

for _, player in pairs(Players:GetPlayers()) do
    setupPlayerMonitoring(player)
end

TrackConnection(Players.PlayerAdded:Connect(function(player)
    setupPlayerMonitoring(player)
end))

TrackConnection(Players.PlayerRemoving:Connect(function(player)
    removePlayerESP(player)
end))

TrackConnection(RunService.Heartbeat:Connect(function()
    if not ESPConfig.Enabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local character = player.Character or workspace:FindFirstChild(player.Name)
            
            if character then
                if PlayerRoles[player] and (not Highlights[player] or not Highlights[player].Parent) then
                    createHighlight(player, PlayerRoles[player])
                end
                
                updatePlayerESP(player)
            end
        end
    end
end))

-- Anti-AFK
task.spawn(function()
    local VirtualInputManager = game:GetService("VirtualInputManager")
    
    while task.wait(300) do
        pcall(function()
            local screenSize = workspace.CurrentCamera.ViewportSize
            local centerX = screenSize.X / 2
            local centerY = screenSize.Y / 2
            
            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 0)
            task.wait(0.1)
            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 0)
        end)
    end
end)

-- Coin Autofarm
task.spawn(function()
    local visitedCoins = {}
    local checkInterval = 3
    local mainGUIReference = nil
    local platformPart = nil
    local currentMapName = nil
    
    local function createPlatform()
        if platformPart and platformPart.Parent then
            platformPart:Destroy()
        end
        
        platformPart = Instance.new("Part")
        platformPart.Name = "AutofarmPlatform"
        platformPart.Size = Vector3.new(10, 1, 10)
        platformPart.Anchored = true
        platformPart.CanCollide = true
        platformPart.Transparency = 1
        platformPart.Material = Enum.Material.SmoothPlastic
        platformPart.Parent = workspace
        
        return platformPart
    end
    
    local function updatePlatform(position)
        if not platformPart or not platformPart.Parent then
            platformPart = createPlatform()
        end
        
        local offset = Vector3.new(0, -3.5, 0)
        platformPart.CFrame = CFrame.new(position + offset)
    end
    
    local function getMainGUI()
        local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
        if playerGui then
            return playerGui:FindFirstChild("MainGUI")
        end
        return nil
    end
    
    local function getCurrentMapName()
        for _, obj in pairs(workspace:GetChildren()) do
            if obj:FindFirstChild("CoinContainer") and obj.Name ~= "Camera" then
                return obj.Name
            end
        end
        return nil
    end
    
    mainGUIReference = getMainGUI()
    currentMapName = getCurrentMapName()
    
    task.spawn(function()
        local lastMapName = nil
        
        while true do
            wait(0.25)
            
            if AutofarmEnabled then
                local currentMapName = nil
                local hasCoinContainer = false
                
                for _, obj in pairs(workspace:GetChildren()) do
                    local container = obj:FindFirstChild("CoinContainer")
                    if container and obj.Name ~= "Camera" then
                        currentMapName = obj.Name
                        hasCoinContainer = true
                        break
                    end
                end
                
                if hasCoinContainer and currentMapName ~= lastMapName then
                    print("üó∫Ô∏è NEW MAP: " .. currentMapName)
                    visitedCoins = {}
                    checkInterval = 0.03
                    mainGUIReference = getMainGUI()
                    lastMapName = currentMapName
                end
                
                if not hasCoinContainer and lastMapName then
                    print("üè† LOBBY - Pausing")
                    visitedCoins = {}
                    checkInterval = 3
                    lastMapName = nil
                    
                    pcall(function()
                        local character = LocalPlayer.Character
                        if character then
                            local hrp = character:FindFirstChild("HumanoidRootPart")
                            if hrp then
                                local bv = hrp:FindFirstChild("AntiGravity")
                                if bv then bv:Destroy() end
                            end
                        end
                    end)
                end
            end
        end
    end)
    
    while true do
        task.wait(checkInterval)
        
        if AutofarmEnabled then
            pcall(function()
                if not mainGUIReference or not mainGUIReference.Parent then
                    mainGUIReference = getMainGUI()
                end
                
                if mainGUIReference then
                    local game = mainGUIReference:FindFirstChild("Game")
                    if game then
                        local coinBags = game:FindFirstChild("CoinBags")
                        if coinBags then
                            local container = coinBags:FindFirstChild("Container")
                            if container then
                                local snowToken = container:FindFirstChild("SnowToken")
                                if snowToken then
                                    local full = snowToken:FindFirstChild("Full")
                                    
                                    if full and full.Visible then
                                        print("üí∞ BAG FULL - Going to safe zone")
                                        
                                        local character = LocalPlayer.Character
                                        if character then
                                            local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                                            if humanoidRootPart then
                                                local bodyVelocity = humanoidRootPart:FindFirstChild("AntiGravity")
                                                if not bodyVelocity then
                                                    bodyVelocity = Instance.new("BodyVelocity")
                                                    bodyVelocity.Name = "AntiGravity"
                                                    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                                                    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                                                    bodyVelocity.Parent = humanoidRootPart
                                                end
                                                
                                                local waitCount = 0
                                                while full and full.Visible and AutofarmEnabled do
                                                    local currentPos = humanoidRootPart.Position
                                                    local targetPos = Vector3.new(currentPos.X, 200, currentPos.Z)
                                                    
                                                    humanoidRootPart.CFrame = CFrame.new(targetPos)
                                                    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                                                    humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
                                                    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                                                    humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                                                    
                                                    updatePlatform(humanoidRootPart.Position)
                                                    
                                                    task.wait()
                                                    waitCount = waitCount + 1
                                                    
                                                    if waitCount > 1000 then
                                                        print("‚ö†Ô∏è Stuck in safe zone - forcing exit")
                                                        break
                                                    end
                                                end
                                                
                                                print("‚úÖ BAG EMPTIED - Resuming autofarm")
                                                
                                                if bodyVelocity then
                                                    bodyVelocity:Destroy()
                                                end
                                                
                                                visitedCoins = {}
                                                checkInterval = 0.03
                                                
                                                task.wait(2)
                                                
                                                return
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
                
                local character = LocalPlayer.Character
                if not character then return end
                
                local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                if not humanoidRootPart then return end
                
                local coinContainerExists = false
                for _, obj in pairs(workspace:GetChildren()) do
                    if obj:FindFirstChild("CoinContainer") then
                        coinContainerExists = true
                        break
                    end
                end
                
                if not coinContainerExists then
                    if humanoidRootPart then
                        updatePlatform(humanoidRootPart.Position)
                    end
                    checkInterval = 3
                    return
                end
                
                local coinContainers = {}
                for _, obj in pairs(workspace:GetDescendants()) do
                    if obj.Name == "CoinContainer" and (obj:IsA("Model") or obj:IsA("Folder")) then
                        table.insert(coinContainers, obj)
                    end
                end
                
                local closestCoin = nil
                local closestDistance = math.huge
                
                for _, container in pairs(coinContainers) do
                    for _, coin in pairs(container:GetChildren()) do
                        if coin.Name == "Coin_Server" and coin:IsA("BasePart") and not visitedCoins[coin] then
                            local distance = (coin.Position - humanoidRootPart.Position).Magnitude
                            
                            if distance < closestDistance and distance <= 500 then
                                closestDistance = distance
                                closestCoin = coin
                            end
                        end
                    end
                end
                
                for coin, _ in pairs(visitedCoins) do
                    if not coin.Parent then
                        visitedCoins[coin] = nil
                    end
                end
                
                if not closestCoin then
                    visitedCoins = {}
                    checkInterval = 3
                    return
                end
                
                checkInterval = 0.03
                visitedCoins[closestCoin] = true
                
                local targetPosition = closestCoin.Position
                local speed = 35
                local startPosition = humanoidRootPart.Position
                local distance = (targetPosition - startPosition).Magnitude
                local duration = distance / speed
                
                local startTime = tick()
                
                local bodyVelocity = humanoidRootPart:FindFirstChild("AntiGravity")
                if not bodyVelocity then
                    bodyVelocity = Instance.new("BodyVelocity")
                    bodyVelocity.Name = "AntiGravity"
                    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                    bodyVelocity.Parent = humanoidRootPart
                end
                
                while AutofarmEnabled and closestCoin.Parent do
                    if not AutofarmEnabled then
                        if bodyVelocity then bodyVelocity:Destroy() end
                        return
                    end
                    
                    if not closestCoin.Parent then
                        break
                    end
                    
                    local coinParent = closestCoin.Parent
                    if coinParent then
                        local coinVisual = coinParent:FindFirstChild("CoinVisual")
                        if coinVisual and coinVisual:IsA("BasePart") and coinVisual.Transparency == 1 then
                            if bodyVelocity then bodyVelocity:Destroy() end
                            break
                        end
                    end
                    
                    local elapsed = tick() - startTime
                    local currentDistance = (humanoidRootPart.Position - targetPosition).Magnitude
                    
                    if currentDistance < 0.5 or elapsed > duration + 1 then
                        for i = 1, 15 do
                            if not closestCoin.Parent then break end
                            
                            if coinParent then
                                local coinVisual = coinParent:FindFirstChild("CoinVisual")
                                if coinVisual and coinVisual:IsA("BasePart") and coinVisual.Transparency == 1 then
                                    break
                                end
                            end
                            
                            humanoidRootPart.CFrame = CFrame.new(targetPosition)
                            humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                            humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
                            humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                            humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                            
                            updatePlatform(humanoidRootPart.Position)
                            
                            task.wait()
                        end
                        break
                    end
                    
                    local alpha = math.min(elapsed / duration, 1)
                    local currentPosition = startPosition:Lerp(targetPosition, alpha)
                    
                    humanoidRootPart.CFrame = CFrame.new(currentPosition)
                    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
                    humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
                    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                    humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                    
                    updatePlatform(humanoidRootPart.Position)
                    
                    task.wait()
                end
                
                if bodyVelocity and bodyVelocity.Parent then
                    bodyVelocity:Destroy()
                end
                
                local coinParent = closestCoin.Parent
                if coinParent then
                    local coinVisual = coinParent:FindFirstChild("CoinVisual")
                    
                    if coinVisual and coinVisual:IsA("BasePart") and coinVisual.Transparency == 1 then
                        task.wait(0.3)
                        return
                    end
                    
                    if coinVisual and coinVisual:IsA("BasePart") and coinVisual.Transparency ~= 1 then
                        task.wait(3)
                    end
                end
                
                task.wait(0.3)
            end)
        end
    end
end)

print("===============================================")
print("MM2 Script Loaded Successfully!")
print("‚úì Auto-Rejoin: ACTIVE")
print("‚úì Auto-Execute: ACTIVE")
if hasFileSystem then
    print("‚úì Settings Save: ACTIVE")
    if savedSettings then
        print("‚úì Previous settings restored!")
    end
else
    print("‚ö† Settings Save: Unavailable")
end
print("===============================================")
